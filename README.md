# 支持光场相机
58119220王浩帆
## 1.数据集
首先，我使用的数据集是Lytro官方的Lytro Dataset，其中含有30张.lfp的图片，都是由Lytro光场相机拍摄而得，同时，这个数据集中还含有白图像data.C.0~3，由于四张白图像文件过大，因此在提交的工程文件中不包含该白图像，在此附上Lytro Dataset的链接：https://www.irisa.fr/temics/demos/lightField/index.html
我使用的是该数据集中的Cocktails.lfp，因为在进行多次运行后，发现该图片所形成的重聚焦后的图像效果较好。同时，在本次实验中，我使用了Matlab中的Light Field Toolbox v0.4，其中，我对LFLytroDecodeImage.m做了部分修改，我也将附上修改后的该解码函数。下面我讲具体说明实现重聚焦的方法。

## 2.处理白图像
处理白图像的目的是得到相机的某些参数，这一步的目的是为了获得每幅光场的中心点坐标。白图像拍摄的场景没有纹理，此时可以清楚的观察到微透镜成像的边界信息。需要注意的是，该过程不是简单地提取出一张白图像来，而是提取几十张白图像对。

## 3.解码LFP文件
我们这里调用了工具箱提供的LFLytroDecodeImage函数，并且修改了LFLytroDecodeImage中的WhiteImageDatabase路径。此时获取的图像较暗，我们对其进行去马赛克操作。解码过后我们得到RGB彩色图像，同时生成一个所有视角的图像。这时候可以看到在边界视角上的图像比较黑，所以我们接下来要进行频域滤波，以及颜色校正。

## 4.频域滤波与颜色矫正
这部分分别用到了LFFilt4DFFT以及LFColourCorrect函数。LFFilt4DFFT函数是将这些变成黑色的图像或者质量不好的图像进行校正的，LFColourCorrect函数是利用gamma变化对原始图像进行颜色校正的。利用这两个函数能够让我们得到的光场图像的质量更好，附件中的bigimg.jpg是经过滤波以及颜色矫正后的所有子孔径图像，可以发现边界的视角相比于频域滤波之前有了很好的可视性。在这个步骤中生成的11x11张图片中，我们生成了一张类似的动图，该视频文件也包含于附件中，由于它是又不同视角的图片组成的动图，我们可以将他视为不同聚焦点的图像，我们可以看出，聚焦点从前面的柠檬转到了后面的鸡尾酒杯上，再转到了后面的柠檬上，最后失焦。在下一步中，我们将通过另一种方式对重聚焦后的图像与原图像做一个显著的对比。

## 5.数字重聚焦
使用该公式可以实现光场图像的全聚焦：Lα(x,y,u,v)=L0(x+(1−1α)u,y+(1−1α)v,u,v)
这是一个降低到四维的全光函数，Lα(x,y,u,v)表示光场的一个采样，L表示光线的强度，(x,y)和(u,v)分别为光线与两个平面的交点坐标。在四维坐标空间中，一条光线对应光场的一个采样点。我们再进行多次重聚焦实验后，得到了三个辨识度较高的参数α值，分别是α=0.2, α=0.2+(1.8/256) * 78, α=2，这三者分别得到的重聚焦效果是失焦，聚焦于前面一片的柠檬上，和聚焦于后面一片的柠檬上，这三种α值对应的三张重聚焦图像也在附件中，可以看到重聚焦的效果是较好的。

## 附录
1.由于该项目中的部分文件过大，无法加入附件中，我在附件中放入了我展示用的ppt，以免在其他用户机上无法运行或是表述不够准确，展示ppt中包含有全部的程序运行结果图像，可以结合readme或是代码进行更好的理解
2.该项目分为两部分，一是处理白图像，解码后进行滤波与颜色矫正，二是进行数字重聚焦，第一步生成的后缀名为mat的5-D图像文件将在第二步中的数字重聚焦中应用，但由于该5-D图像文件过大，因此我也没有将它加入附件中，附件中的Decoding文件夹包含了解码的部分函数以及运行后的经过颜色矫正的所有视角的图像bigimg.jpg，另一个Refocusing文件夹包含了数字重聚焦所需的全部代码，以及经过三个不同α生成的三种不同的重聚焦图像。

希望该readme文件能够帮助您更好理解我的项目以及实验结果！
 
